
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Random Thoughts">
      
      
      
        <link rel="canonical" href="https://AXGKl.github.io/blog/cloud/terraform/k8s/k8s_on_do/">
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.9">
    
    
      
        <title>K8s Cluster Infra - AXGK Blog</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.120efc48.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.9647289d.min.css">
        
          
          
          <meta name="theme-color" content="#000000">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../lcd/lp/css/xterm.min.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="preference" data-md-color-primary="black" data-md-color-accent="deep-purple">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#k8s-with-terraform" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="AXGK Blog" class="md-header__button md-logo" aria-label="AXGK Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m19 2-5 4.5v11l5-4.5V2M6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            AXGK Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              K8s Cluster Infra
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/AXGKl/blog" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    AXGKl/blog
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../../.." class="md-tabs__link">
      Overview
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../../ll/apps/apps/" class="md-tabs__link">
        üêß LINUX
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../dnsmasq/" class="md-tabs__link md-tabs__link--active">
        üí≠ CLOUD
      </a>
    </li>
  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../../programming/python/rx/" class="md-tabs__link">
        üíª DEV
      </a>
    </li>
  

  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../../../inet/videos/" class="md-tabs__link">
      üì∫ VIDS
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../../../logbook/" class="md-tabs__link">
      ‚úèÔ∏è  LOG
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../../about/changelog/" class="md-tabs__link">
        About
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="AXGK Blog" class="md-nav__button md-logo" aria-label="AXGK Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m19 2-5 4.5v11l5-4.5V2M6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5Z"/></svg>

    </a>
    AXGK Blog
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/AXGKl/blog" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    AXGKl/blog
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" data-md-state="indeterminate" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          üêß LINUX
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="üêß LINUX" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          üêß LINUX
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/apps/apps/" class="md-nav__link">
        Apps
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/devices/tv_q8/" class="md-nav__link">
        Devices
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/distro/" class="md-nav__link">
        Distros
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/arco/" class="md-nav__link">
        Distros
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/emacs/emacs/" class="md-nav__link">
        Emacs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/gimp/gimp/" class="md-nav__link">
        Gimp
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_7" data-md-state="indeterminate" type="checkbox" id="__nav_2_7" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2_7">
          Hardware
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Hardware" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_7">
          <span class="md-nav__icon md-icon"></span>
          Hardware
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_7_1" data-md-state="indeterminate" type="checkbox" id="__nav_2_7_1" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2_7_1">
          Input
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Input" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_7_1">
          <span class="md-nav__icon md-icon"></span>
          Input
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/hw/input/keyboard/" class="md-nav__link">
        Keyboard
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/hw/input/k860/" class="md-nav__link">
        K860
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/hw/input/corne/" class="md-nav__link">
        Corne
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/hw/input/hp/" class="md-nav__link">
        HP
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/mkdocs/mkdocs/" class="md-nav__link">
        MkDocs
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_9" data-md-state="indeterminate" type="checkbox" id="__nav_2_9" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2_9">
          Suckless
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Suckless" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_9">
          <span class="md-nav__icon md-icon"></span>
          Suckless
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/sl/about/" class="md-nav__link">
        About
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/sl/dwm/" class="md-nav__link">
        dwm
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/sl/st/" class="md-nav__link">
        st
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_9_4" data-md-state="indeterminate" type="checkbox" id="__nav_2_9_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2_9_4">
          Statusbar Fun
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Statusbar Fun" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_9_4">
          <span class="md-nav__icon md-icon"></span>
          Statusbar Fun
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/sl/status_bar_fun/2021.05.23_dwm_status_1_a_fancy_status_bar/" class="md-nav__link">
        The Problem
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/sl/status_bar_fun/2021.05.24_dwm_status_2_never_call_xsession_within_dwm/" class="md-nav__link">
        XFCE
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/sl/status_bar_fun/2021.05.24_dwm_status_3_xfce4_panel_in_dwm/" class="md-nav__link">
        XFCE Panel in DWM
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/sl/status_bar_fun/2021.05.24_dwm_status_4_adding_our_monitor/" class="md-nav__link">
        CPU Monitor
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_10" data-md-state="indeterminate" type="checkbox" id="__nav_2_10" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2_10">
          Vim
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Vim" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_10">
          <span class="md-nav__icon md-icon"></span>
          Vim
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/vim/vim/" class="md-nav__link">
        About
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/vim/astro_vim/" class="md-nav__link">
        AstroVim
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/vim/astro_vim_null_ls_builtins/" class="md-nav__link">
        AstroVimLspBuiltins
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/vim/ultisnips/" class="md-nav__link">
        Ultisnips
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/vim/html/" class="md-nav__link">
        HTML
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/todo/" class="md-nav__link">
        Todo
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          üí≠ CLOUD
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="üí≠ CLOUD" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          üí≠ CLOUD
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../dnsmasq/" class="md-nav__link">
        DNSMasq
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ci/github_actions/" class="md-nav__link">
        Github Actions
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3" data-md-state="indeterminate" type="checkbox" id="__nav_3_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3_3">
          Kubernetes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Kubernetes" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_3">
          <span class="md-nav__icon md-icon"></span>
          Kubernetes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../k8s/" class="md-nav__link">
        Notes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../k8s/k9s/k9s/" class="md-nav__link">
        K9s Terminal UI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../k8s/1_hello_app/" class="md-nav__link">
        First App
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../k8s/2_hello_mysql/" class="md-nav__link">
        With DB
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4" type="checkbox" id="__nav_3_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3_4">
          Terraform
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Terraform" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_4">
          <span class="md-nav__icon md-icon"></span>
          Terraform
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        About
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../resource_creation/" class="md-nav__link">
        Basic Operation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ansible/" class="md-nav__link">
        TF And Ansible
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Kubernetes
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          K8s Cluster Infra
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        K8s Cluster Infra
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#requirements" class="md-nav__link">
    Requirements
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#environ" class="md-nav__link">
    Environ
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#config" class="md-nav__link">
    Config
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#init-plan-apply" class="md-nav__link">
    Init - Plan - Apply
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-kubectl" class="md-nav__link">
    Configure kubectl
  </a>
  
    <nav class="md-nav" aria-label="Configure kubectl">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#private-registry-image-pulling" class="md-nav__link">
    Private Registry Image Pulling
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#discussion" class="md-nav__link">
    Discussion
  </a>
  
    <nav class="md-nav" aria-label="Discussion">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#raw-kubernetes-is-hard" class="md-nav__link">
    Raw Kubernetes is Hard
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#config-security" class="md-nav__link">
    Config / Security
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apply-errors-do-happen" class="md-nav__link">
    Apply Errors Do Happen
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#further-readings" class="md-nav__link">
    Further Readings
  </a>
  
    <nav class="md-nav" aria-label="Further Readings">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#k8s-os" class="md-nav__link">
    K8s -&gt; OS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#svc-mesh" class="md-nav__link">
    Svc Mesh
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../k8s_provider/do_k8s/" class="md-nav__link">
        Attaching Using Token Only
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../k8s_provider/k8s_provider/" class="md-nav__link">
        The K8s Provider
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" data-md-state="indeterminate" type="checkbox" id="__nav_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          üíª DEV
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="üíª DEV" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          üíª DEV
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1" data-md-state="indeterminate" type="checkbox" id="__nav_4_1" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1">
          üêç Python
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="üêç Python" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          üêç Python
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/rx/" class="md-nav__link">
        Reactive Programming With RxPY
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_2" data-md-state="indeterminate" type="checkbox" id="__nav_4_1_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1_2">
          TermUIs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="TermUIs" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_1_2">
          <span class="md-nav__icon md-icon"></span>
          TermUIs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/prompt_toolkit/" class="md-nav__link">
        Prompt Toolkit
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programming/python/prompt_toolkit/dup2/" class="md-nav__link">
        Stream Control
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_3" data-md-state="indeterminate" type="checkbox" id="__nav_4_1_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1_3">
          Fun
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Fun" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_1_3">
          <span class="md-nav__icon md-icon"></span>
          Fun
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/fun/unblockme/" class="md-nav__link">
        UnblockMe
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/fun/einstein/" class="md-nav__link">
        Einstein
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" data-md-state="indeterminate" type="checkbox" id="__nav_4_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2">
          Electronics
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Electronics" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Electronics
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/electronics/" class="md-nav__link">
        Interacting with Real World
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_2" data-md-state="indeterminate" type="checkbox" id="__nav_4_2_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2_2">
          Desk Cycling
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Desk Cycling" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_2_2">
          <span class="md-nav__icon md-icon"></span>
          Desk Cycling
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/electronics/deskcycle/intro/" class="md-nav__link">
        Zwiftifying My DeskCycle
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/electronics/deskcycle/powermeter/" class="md-nav__link">
        Power Meters
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/electronics/deskcycle/mechanical/" class="md-nav__link">
        Know the Gear Position
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/electronics/deskcycle/electromagnet/" class="md-nav__link">
        Electromagent
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ll/electronics/deskcycle/generator/" class="md-nav__link">
        Generating Power
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../inet/videos/" class="md-nav__link">
        üì∫ VIDS
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../logbook/" class="md-nav__link">
        ‚úèÔ∏è  LOG
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" data-md-state="indeterminate" type="checkbox" id="__nav_7" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          About
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="About" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          About
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../about/changelog/" class="md-nav__link">
        Changelog
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../about/navigation/" class="md-nav__link">
        Navigation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#requirements" class="md-nav__link">
    Requirements
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#environ" class="md-nav__link">
    Environ
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#config" class="md-nav__link">
    Config
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#init-plan-apply" class="md-nav__link">
    Init - Plan - Apply
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-kubectl" class="md-nav__link">
    Configure kubectl
  </a>
  
    <nav class="md-nav" aria-label="Configure kubectl">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#private-registry-image-pulling" class="md-nav__link">
    Private Registry Image Pulling
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#discussion" class="md-nav__link">
    Discussion
  </a>
  
    <nav class="md-nav" aria-label="Discussion">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#raw-kubernetes-is-hard" class="md-nav__link">
    Raw Kubernetes is Hard
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#config-security" class="md-nav__link">
    Config / Security
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apply-errors-do-happen" class="md-nav__link">
    Apply Errors Do Happen
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#further-readings" class="md-nav__link">
    Further Readings
  </a>
  
    <nav class="md-nav" aria-label="Further Readings">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#k8s-os" class="md-nav__link">
    K8s -&gt; OS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#svc-mesh" class="md-nav__link">
    Svc Mesh
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="editor:///home/gk/repos/blog/docs/cloud/terraform/k8s/k8s_on_do.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<style>

          @media only screen and (min-width: 76.25em) {
            .md-main__inner {
              max-width: none;
            }
            .md-sidebar--primary {
              left: 0;
            }
            .md-sidebar--secondary {
              right: 0;
              margin-left: 0;
              -webkit-transform: none;
              transform: none;   
            }
          }

</style>
<h1 id="k8s-with-terraform">K8s With Terraform<a class="headerlink" href="#k8s-with-terraform" title="Permanent link">¬§</a></h1>
<p>Here we learn how to get to a K8s instance running on a cloud provider. </p>
<p>We use Digitial Ocean(DO) as cloud provider, AWS is well documented.</p>
<div class="admonition tip">
<p class="admonition-title">Local K8s Test Instances</p>
<p>When you do not have a cloud infra provider or want something for CI then use <a href="https://kind.sigs.k8s.io/docs/user/quick-start">"kind"</a>.
On the Terraform page there is a <a href="https://learn.hashicorp.com/tutorials/terraform/kubernetes-provider?in=terraform/kubernetes">nice example</a> how to use it.</p>
</div>
<h2 id="requirements">Requirements<a class="headerlink" href="#requirements" title="Permanent link">¬§</a></h2>
<ul>
<li>
<p>Have local:</p>
<ul>
<li>The cloud provider client (here: <code>doctl</code>)</li>
<li>The terraform binary</li>
<li>podman or docker (here only to configure access to our private registry for k8s, via their
  auth file they create after login). I.e. only for convenience.</li>
<li>Optional: We use the <code>pass</code> utility since we don't want sensitive values being shown</li>
</ul>
</li>
<li>
<p>Have an API token for DO  </p>
</li>
<li>Optional: Private container registry url with creds</li>
</ul>
<!-- id: 50399f954c9194e6f1a5d146710df984 -->

<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Cmd</label><label for="__tabbed_1_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="gp">$ </span><span class="nb">type</span> doctl terraform kubectl podman pass
<span class="gp">$ </span>pass show DO/pat <span class="p">|</span> head -c <span class="m">5</span>
<span class="gp">$ </span><span class="nv">D</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$DT_PROJECT_ROOT</span><span class="s2">/tmp/clusters/DO/k8s&quot;</span>
<span class="gp">$ </span>mkdir -p <span class="s2">&quot;</span><span class="nv">$D</span><span class="s2">&quot;</span>
<span class="gp">$ </span><span class="nb">cd</span> <span class="s2">&quot;</span><span class="nv">$D</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="nb">exit</span> <span class="m">1</span>
<span class="gp">$ </span><span class="nb">export</span> <span class="nv">TF_VAR_do_token</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>pass show DO/pat<span class="k">)</span><span class="s2">&quot;</span>
<span class="gp">$ </span>terraform destroy -auto-approve -lock<span class="o">=</span><span class="nb">false</span>      <span class="c1"># lp: expect=complete timeout=100</span>
<span class="gp">$ </span>ls -a <span class="p">|</span> xargs rm -rf <span class="m">2</span>&gt;/dev/null
</code></pre></div>
</div>
<div class="tabbed-block">
<p><xterm /></p>
<pre><code>$ type doctl terraform kubectl podman pass            
doctl is /usr/local/bin/doctl           
terraform is /usr/local/bin/terraform   
kubectl is /usr/local/bin/kubectl       
podman is /usr/bin/podman               
pass is /usr/bin/pass
$ pass show DO/pat | head -c 5                        
7ba23
$ D="$DT_PROJECT_ROOT/tmp/clusters/DO/k8s"
$ mkdir -p "$D"
$ cd "$D" || exit 1
$ export TF_VAR_do_token="$(pass show DO/pat)"
$ terraform destroy -auto-approve -lock=false

[1m[32mNo changes.[39m No objects need to be destroyed.[0m[39m[49m

Either you have not created any objects yet or the existing objects were        
already deleted outside of Terraform.

[1m[32mDestroy complete! Resources: 0 destroyed.[0m[39m[49m                                       
$
$ ls -a | xargs rm -rf 2&gt;/dev/null
</code></pre>
</div>
</div>
</div>
<!-- id: 50399f954c9194e6f1a5d146710df984 -->

<h2 id="environ">Environ<a class="headerlink" href="#environ" title="Permanent link">¬§</a></h2>
<p>Lets create a file which sets up our working environ, when sourced - convenient for new shells:</p>
<!-- id: 5b43033370d9d912789240700c624970 -->
<div class="highlight"><pre><span></span><code>$ cat environ
<span class="nb">set</span> -ae
<span class="nb">alias</span> <span class="nv">tf</span><span class="o">=</span>terraform <span class="nv">k</span><span class="o">=</span>kubectl

<span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$0</span><span class="s2">&quot;</span> <span class="o">=</span> *bash* <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">s</span><span class="o">=</span>bash <span class="o">||</span> <span class="nv">s</span><span class="o">=</span>zsh
<span class="nb">source</span> &lt;<span class="o">(</span>kubectl completion <span class="nv">$s</span><span class="o">)</span>

<span class="nb">export</span> <span class="nv">D</span><span class="o">=</span><span class="s2">&quot;/home/gk/repos/blog/tmp/clusters/DO/k8s&quot;</span>
<span class="nb">cd</span> <span class="s2">&quot;</span><span class="nv">$D</span><span class="s2">&quot;</span>
<span class="nv">TF_VAR_do_token</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>pass show DO/pat<span class="k">)</span><span class="s2">&quot;</span>
<span class="nv">clustername</span><span class="o">=</span><span class="s2">&quot;tf-do-cluster-d1&quot;</span>
<span class="nv">latest_k8s_ver</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>doctl kubernetes options versions <span class="p">|</span> grep -A <span class="m">1</span> Slug <span class="p">|</span> tail -n <span class="m">1</span> <span class="p">|</span> cut -d  <span class="s1">&#39; &#39;</span> -f1 <span class="p">|</span> xargs<span class="k">)</span><span class="s2">&quot;</span>
<span class="nb">set</span> +ae
</code></pre></div>
<!-- id: 5b43033370d9d912789240700c624970 -->

<h2 id="config">Config<a class="headerlink" href="#config" title="Permanent link">¬§</a></h2>
<!-- id: 3c362fb0c0ee9ad86517cc916fb36af3 -->

<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Cmd</label><label for="__tabbed_2_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="gp">$ </span><span class="nb">source</span> environ
<span class="gp">$ </span>cat &lt;&lt; EOF &gt; provider.tf
<span class="go">terraform {</span>
<span class="go">  required_providers {</span>
<span class="go">    digitalocean = {</span>
<span class="go">      source = &quot;digitalocean/digitalocean&quot;</span>
<span class="go">      version = &quot;~&gt; 2.0&quot;</span>
<span class="go">    }</span>
<span class="go">  }</span>
<span class="go">}</span>
<span class="go">  </span>
<span class="go">variable &quot;do_token&quot; { }</span>
<span class="go">  </span>
<span class="go">data &quot;digitalocean_ssh_key&quot; &quot;terraform&quot; {</span>
<span class="go">      name = &quot;terraform&quot;</span>
<span class="go">}</span>
<span class="go">provider &quot;digitalocean&quot; {</span>
<span class="go">    token = var.do_token</span>
<span class="go">}</span>
<span class="go">EOF</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p><xterm /></p>
<pre><code>$ source environ
$ cat &lt;&lt; EOF &gt; provider.tf              
&gt; terraform {       
&gt;   required_providers {                
&gt;     digitalocean = {                  
&gt;       source = "digitalocean/digitalocean"                                    
&gt;       version = "~&gt; 2.0"              
&gt;     }             
&gt;   }               
&gt; }                 
&gt;                   
&gt; variable "do_token" { }               
&gt;                   
&gt; data "digitalocean_ssh_key" "terraform" {                                     
&gt;       name = "terraform"              
&gt; }                 
&gt; provider "digitalocean" {             
&gt;     token = var.do_token              
&gt; }                 
&gt; EOF               
$
</code></pre>
</div>
</div>
</div>
<!-- id: 3c362fb0c0ee9ad86517cc916fb36af3 -->

<!-- using q unique name -->

<!-- id: b964b95a7aa3eb40b84d420180ae1c0d -->

<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">Cmd</label><label for="__tabbed_3_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>cat &lt;&lt; EOF &gt; <span class="k">do</span>-kubernetes.tf
<span class="go">resource &quot;digitalocean_kubernetes_cluster&quot; &quot;kubernetes_cluster&quot; {</span>
<span class="go">  name    = &quot;$clustername&quot;</span>
<span class="go">  region  = &quot;fra1&quot;</span>
<span class="go">  version = &quot;$latest_k8s_ver&quot;</span>

<span class="go">  tags = [&quot;my-tag&quot;, &quot;d1&quot;]</span>

<span class="gp">  # </span>This default node pool is mandatory
<span class="go">  node_pool {</span>
<span class="go">    name       = &quot;default-pool&quot;</span>
<span class="go">    size       = &quot;s-1vcpu-2gb&quot; # minimum size, list available options with doctl compute size list</span>
<span class="go">    auto_scale = false</span>
<span class="go">    node_count = 2</span>
<span class="go">    tags       = [&quot;node-pool-tag&quot;]</span>
<span class="go">    labels = {</span>
<span class="go">    }</span>
<span class="go">  }</span>

<span class="go">}</span>

<span class="gp"># </span>A node pool <span class="k">for</span> applications
<span class="go">resource &quot;digitalocean_kubernetes_node_pool&quot; &quot;app_node_pool&quot; {</span>
<span class="go">  cluster_id = digitalocean_kubernetes_cluster.kubernetes_cluster.id</span>

<span class="go">  name = &quot;app-pool&quot;</span>
<span class="go">  size = &quot;s-2vcpu-4gb&quot;</span>
<span class="go">  tags = [&quot;applications&quot;]</span>

<span class="gp">  # </span>you can setup autoscaling
<span class="go">  auto_scale = true</span>
<span class="go">  min_nodes  = 2</span>
<span class="go">  max_nodes  = 10</span>
<span class="go">  labels = {</span>
<span class="go">    service  = &quot;apps&quot;</span>
<span class="go">    priority = &quot;high&quot;</span>
<span class="go">  }</span>
<span class="go">}</span>
<span class="go">EOF</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p><xterm /></p>
<pre><code>$ cat &lt;&lt; EOF &gt; do-kubernetes.tf         
&gt; resource "digitalocean_kubernetes_cluster" "kubernetes_cluster" {             
&gt;   name    = "$clustername"            
&gt;   region  = "fra1"
&gt;   version = "$latest_k8s_ver"         
&gt;                   
&gt;   tags = ["my-tag", "d1"]             
&gt;                   
&gt;   # This default node pool is mandatory                                       
&gt;   node_pool {     
&gt;     name       = "default-pool"       
&gt;     size       = "s-1vcpu-2gb" # minimum size, list available options with doctl compute size list                    
&gt;     auto_scale = false                
&gt;     node_count = 2
&gt;     tags       = ["node-pool-tag"]    
&gt;     labels = {    
&gt;     }             
&gt;   }               
&gt;                   
&gt; }                 
&gt;                   
&gt; # A node pool for applications        
&gt; resource "digitalocean_kubernetes_node_pool" "app_node_pool" {                
&gt;   cluster_id = digitalocean_kubernetes_cluster.kubernetes_cluster.id          
&gt;                   
&gt;   name = "app-pool"                   
&gt;   size = "s-2vcpu-4gb"                
&gt;   tags = ["applications"]             
&gt;                   
&gt;   # you can setup autoscaling         
&gt;   auto_scale = true                   
&gt;   min_nodes  = 2  
&gt;   max_nodes  = 10 
&gt;   labels = {      
&gt;     service  = "apps"                 
&gt;     priority = "high"                 
&gt;   }               
&gt; }                 
&gt; EOF               
$
</code></pre>
</div>
</div>
</div>
<!-- id: b964b95a7aa3eb40b84d420180ae1c0d -->

<h2 id="init-plan-apply">Init - Plan - Apply<a class="headerlink" href="#init-plan-apply" title="Permanent link">¬§</a></h2>
<!-- id: a83f4712457c517166019262b44fbf7a -->

<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">Cmd</label><label for="__tabbed_4_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>tf init <span class="c1"># lp: asserts=&quot;successfully initialized&quot;</span>
<span class="gp">$ </span>tf plan <span class="c1"># lp: asserts=&quot;to add&quot;</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p><xterm /></p>
<pre><code>$ tf init

[1mInitializing the backend...[0m[39m[49m

[1mInitializing provider plugins...[0m[39m[49m        
- Finding digitalocean/digitalocean versions matching "~&gt; 2.0"...               
- Installing digitalocean/digitalocean v2.11.0...                               
- Installed digitalocean/digitalocean v2.11.0 (signed by a HashiCorp partner, key ID [1mF82037E524B9C0E8[0m[39m[49m)

Partner and community providers are signed by their developers.                 
If you'd like to know more about provider signing, you can read about it here:  
https://www.terraform.io/docs/cli/plugins/signing.html

Terraform has created a lock file [1m.terraform.lock.hcl[0m[39m[49m to record the provider    
selections it made above. Include this file in your version control repository  
so that Terraform can guarantee to make the same selections by default when     
you run "terraform init" in the future.

[1m[32mTerraform has been successfully initialized![0m[39m[49m

[32mYou may now begin working with Terraform. Try running "terraform plan" to see[39m   
[32many changes that are required for your infrastructure. All Terraform commands[39m   
[32mshould now work.[39m

[32mIf you ever set or change modules or backend configuration for Terraform,[39m       
[32mrerun this command to reinitialize your working directory. If you forget, other[39m 
[32mcommands will detect it and remind you to do so if necessary.[39m
$ tf plan

Terraform used the selected providers to generate the following execution plan. 
Resource actions are indicated with the following symbols:                      
  [32m+[39m create

Terraform will perform the following actions:

[1m  # digitalocean_kubernetes_cluster.kubernetes_cluster[0m[39m[49m will be created          
  [32m+[39m resource "digitalocean_kubernetes_cluster" "kubernetes_cluster" {           
      [32m+[39m cluster_subnet = (known after apply)                                    
      [32m+[39m created_at     = (known after apply)                                    
      [32m+[39m endpoint       = (known after apply)                                    
      [32m+[39m id             = (known after apply)                                    
      [32m+[39m ipv4_address   = (known after apply)                                    
      [32m+[39m kube_config    = (sensitive value)                                      
      [32m+[39m name           = "tf-do-cluster-d1"                                     
      [32m+[39m region         = "fra1"         
      [32m+[39m service_subnet = (known after apply)                                    
      [32m+[39m status         = (known after apply)                                    
      [32m+[39m surge_upgrade  = true           
      [32m+[39m tags           = [              
          [32m+[39m "d1",   
          [32m+[39m "my-tag",                   
        ]           
      [32m+[39m updated_at     = (known after apply)                                    
      [32m+[39m urn            = (known after apply)                                    
      [32m+[39m version        = "1.21.2-do.2"  
      [32m+[39m vpc_uuid       = (known after apply)

      [32m+[39m maintenance_policy {            
          [32m+[39m day        = (known after apply)                                    
          [32m+[39m duration   = (known after apply)                                    
          [32m+[39m start_time = (known after apply)                                    
        }

      [32m+[39m node_pool { 
          [32m+[39m actual_node_count = (known after apply)                             
          [32m+[39m auto_scale        = false   
          [32m+[39m id                = (known after apply)                             
          [32m+[39m name              = "default-pool"                                  
          [32m+[39m node_count        = 2       
          [32m+[39m nodes             = (known after apply)                             
          [32m+[39m size              = "s-1vcpu-2gb"                                   
          [32m+[39m tags              = [       
              [32m+[39m "node-pool-tag",        
            ]       
        }           
    }

[1m  # digitalocean_kubernetes_node_pool.app_node_pool[0m[39m[49m will be created             
  [32m+[39m resource "digitalocean_kubernetes_node_pool" "app_node_pool" {              
      [32m+[39m actual_node_count = (known after apply)                                 
      [32m+[39m auto_scale        = true        
      [32m+[39m cluster_id        = (known after apply)                                 
      [32m+[39m id                = (known after apply)                                 
      [32m+[39m labels            = {           
          [32m+[39m "priority" = "high"         
          [32m+[39m "service"  = "apps"         
        }           
      [32m+[39m max_nodes         = 10          
      [32m+[39m min_nodes         = 2           
      [32m+[39m name              = "app-pool"  
      [32m+[39m nodes             = (known after apply)                                 
      [32m+[39m size              = "s-2vcpu-4gb"                                       
      [32m+[39m tags              = [           
          [32m+[39m "applications",             
        ]           
    }

[1mPlan:[0m[39m[49m 2 to add, 0 to change, 0 to destroy.

[90m‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ[39m

Note: You didn't use the -out option to save this plan, so Terraform can't      
guarantee to take exactly these actions if you run "terraform apply" now.
</code></pre>
</div>
</div>
</div>
<!-- id: a83f4712457c517166019262b44fbf7a -->

<p>Create it:</p>
<!-- have seen 5minutes for mgmt pool -->
<!-- id: da37cc47e3563b6b6b1ec93c56c844a4 -->

<div class="tabbed-set tabbed-alternate" data-tabs="5:2"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><input id="__tabbed_5_2" name="__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="__tabbed_5_1">Cmd</label><label for="__tabbed_5_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="gp">$ </span><span class="nb">time</span> tf apply -auto-approve
</code></pre></div>
</div>
<div class="tabbed-block">
<p><xterm /></p>
<pre><code>$ time tf apply -auto-approve

Terraform used the selected providers to generate the following execution plan. 
Resource actions are indicated with the following symbols:                      
  [32m+[39m create

Terraform will perform the following actions:

[1m  # digitalocean_kubernetes_cluster.kubernetes_cluster[0m[39m[49m will be created          
  [32m+[39m resource "digitalocean_kubernetes_cluster" "kubernetes_cluster" {           
      [32m+[39m cluster_subnet = (known after apply)                                    
      [32m+[39m created_at     = (known after apply)                                    
      [32m+[39m endpoint       = (known after apply)                                    
      [32m+[39m id             = (known after apply)                                    
      [32m+[39m ipv4_address   = (known after apply)                                    
      [32m+[39m kube_config    = (sensitive value)                                      
      [32m+[39m name           = "tf-do-cluster-d1"                                     
      [32m+[39m region         = "fra1"         
      [32m+[39m service_subnet = (known after apply)                                    
      [32m+[39m status         = (known after apply)                                    
      [32m+[39m surge_upgrade  = true           
      [32m+[39m tags           = [              
          [32m+[39m "d1",   
          [32m+[39m "my-tag",                   
        ]           
      [32m+[39m updated_at     = (known after apply)                                    
      [32m+[39m urn            = (known after apply)                                    
      [32m+[39m version        = "1.21.2-do.2"  
      [32m+[39m vpc_uuid       = (known after apply)

      [32m+[39m maintenance_policy {            
          [32m+[39m day        = (known after apply)                                    
          [32m+[39m duration   = (known after apply)                                    
          [32m+[39m start_time = (known after apply)                                    
        }

      [32m+[39m node_pool { 
          [32m+[39m actual_node_count = (known after apply)                             
          [32m+[39m auto_scale        = false   
          [32m+[39m id                = (known after apply)                             
          [32m+[39m name              = "default-pool"                                  
          [32m+[39m node_count        = 2       
          [32m+[39m nodes             = (known after apply)                             
          [32m+[39m size              = "s-1vcpu-2gb"                                   
          [32m+[39m tags              = [       
              [32m+[39m "node-pool-tag",        
            ]       
        }           
    }

[1m  # digitalocean_kubernetes_node_pool.app_node_pool[0m[39m[49m will be created             
  [32m+[39m resource "digitalocean_kubernetes_node_pool" "app_node_pool" {              
      [32m+[39m actual_node_count = (known after apply)                                 
      [32m+[39m auto_scale        = true        
      [32m+[39m cluster_id        = (known after apply)                                 
      [32m+[39m id                = (known after apply)                                 
      [32m+[39m labels            = {           
          [32m+[39m "priority" = "high"         
          [32m+[39m "service"  = "apps"         
        }           
      [32m+[39m max_nodes         = 10          
      [32m+[39m min_nodes         = 2           
      [32m+[39m name              = "app-pool"  
      [32m+[39m nodes             = (known after apply)                                 
      [32m+[39m size              = "s-2vcpu-4gb"                                       
      [32m+[39m tags              = [           
          [32m+[39m "applications",             
        ]           
    }

[1mPlan:[0m[39m[49m 2 to add, 0 to change, 0 to destroy.                                      
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Creating...[0m[39m[49m                 
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [10s elapsed][0m[39m[49m 
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [20s elapsed][0m[39m[49m 
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [30s elapsed][0m[39m[49m 
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [40s elapsed][0m[39m[49m 
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [50s elapsed][0m[39m[49m 
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [1m0s elapsed]
digitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [1m10s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [1m20s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [1m30s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [1m40s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [1m50s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [2m0s elapsed]
digitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [2m10s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [2m20s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [2m30s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [2m40s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [2m50s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [3m0s elapsed]
digitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [3m10s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [3m20s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [3m30s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [3m40s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [3m50s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [4m0s elapsed]
digitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [4m10s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [4m20s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [4m30s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [4m40s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [4m50s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [5m0s elapsed]
digitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [5m10s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [5m20s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [5m30s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [5m40s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [5m50s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [6m0s elapsed]
digitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [6m10s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [6m20s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [6m30s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [6m40s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [6m50s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [7m0s elapsed]
digitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [7m10s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Still creating... [7m20s elapsed][0m[39m[49m                    
[1mdigitalocean_kubernetes_cluster.kubernetes_cluster: Creation complete after 7m23s [id=f87c35a9-2545-4d28-a982-c42a70deb997][0m[39m[49m   
[1mdigitalocean_kubernetes_node_pool.app_node_pool: Creating...[0m[39m[49m                        
[1mdigitalocean_kubernetes_node_pool.app_node_pool: Still creating... [10s elapsed][0m[39m[49m    
[1mdigitalocean_kubernetes_node_pool.app_node_pool: Still creating... [20s elapsed][0m[39m[49m    
[1mdigitalocean_kubernetes_node_pool.app_node_pool: Still creating... [30s elapsed][0m[39m[49m    
[1mdigitalocean_kubernetes_node_pool.app_node_pool: Still creating... [40s elapsed][0m[39m[49m    
[1mdigitalocean_kubernetes_node_pool.app_node_pool: Still creating... [50s elapsed][0m[39m[49m    
[1mdigitalocean_kubernetes_node_pool.app_node_pool: Still creating... [1m0s elapsed][0m[39m[49m   
[1mdigitalocean_kubernetes_node_pool.app_node_pool: Still creating... [1m10s elapsed][0m[39m[49m  
[1mdigitalocean_kubernetes_node_pool.app_node_pool: Still creating... [1m20s elapsed][0m[39m[49m  
[1mdigitalocean_kubernetes_node_pool.app_node_pool: Still creating... [1m30s elapsed][0m[39m[49m  
[1mdigitalocean_kubernetes_node_pool.app_node_pool: Still creating... [1m40s elapsed][0m[39m[49m  
[1mdigitalocean_kubernetes_node_pool.app_node_pool: Still creating... [1m50s elapsed][0m[39m[49m  
[1mdigitalocean_kubernetes_node_pool.app_node_pool: Still creating... [2m0s elapsed][0m[39m[49m   
[1mdigitalocean_kubernetes_node_pool.app_node_pool: Still creating... [2m10s elapsed][0m[39m[49m  
[1mdigitalocean_kubernetes_node_pool.app_node_pool: Creation complete after 2m11s [id=92d20dac-14c4-4d70-86fd-6885b4152215][0m[39m[49m

[1m[32mApply complete! Resources: 2 added, 0 changed, 0 destroyed.[0m[39m[49m

real    9m35.042s    
user    0m1.750s     
sys     0m0.345s
</code></pre>
</div>
</div>
</div>
<!-- id: da37cc47e3563b6b6b1ec93c56c844a4 -->

<p>Should be done in a few minutes. Large variations, I saw between 5 and 15 minutes...</p>
<h2 id="configure-kubectl">Configure <code>kubectl</code><a class="headerlink" href="#configure-kubectl" title="Permanent link">¬§</a></h2>
<div class="admonition note">
<p class="admonition-title">why?</p>
<p>No matter how much we'll do in terraform or other tools, a configured kubectl is simply a must have for clusters you created - and if it is
only to <a href="../../../k8s/">crosscheck</a>.</p>
</div>
<!-- id: c02ab9a58c50c40f86596e478c319c35 -->

<div class="tabbed-set tabbed-alternate" data-tabs="6:2"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><input id="__tabbed_6_2" name="__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="__tabbed_6_1">Cmd</label><label for="__tabbed_6_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>doctl kubernetes cluster kubeconfig save <span class="s2">&quot;</span><span class="nv">$clustername</span><span class="s2">&quot;</span> <span class="c1"># lp: asserts=&quot;Adding cluster&quot;</span>
<span class="gp">$ </span>kubectl cluster-info                                    <span class="c1"># lp: asserts=&quot;control plane&quot;</span>
<span class="gp">$ </span>k cluster-info dump <span class="p">|</span> wc -l                             <span class="c1"># hf ;-)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p><xterm /></p>
<pre><code>$ doctl kubernetes cluster kubeconfig save "$clustername" 
[32mNotice[39m: Adding cluster credentials to kubeconfig file found in "/home/gk/.kube/config"                   
[32mNotice[39m: Setting current-context to do-fra1-tf-do-cluster-d1
$ kubectl cluster-info                                    
[32mKubernetes control plane[39m is running at [33mhttps://f87c35a9-2545-4d28-a982-c42a70deb997.k8s.ondigitalocean.com[39m                    
[32mCoreDNS[39m is running at [33mhttps://f87c35a9-2545-4d28-a982-c42a70deb997.k8s.ondigitalocean.com/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy[39m

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
$ k cluster-info dump | wc -l                             # hf ;-)                  
18346                
$
</code></pre>
</div>
</div>
</div>
<!-- id: c02ab9a58c50c40f86596e478c319c35 -->

<p>The first command configures the default cluster for <code>kubectl</code>, no need to specify the name then, when you
work "only" with one.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Using terraform you do <em>NOT</em> necessarily require a local <code>~/.kube/config</code> file. You can use the
tf k8s provider also <a href="../k8s_provider/do_k8s/">using the token alone</a>.</p>
</div>
<!-- id: 5f0194057674c1687fd6b6f37d1b78f4 -->
<p><xterm /></p>
<pre><code>$ k get nodes   
NAME                 STATUS   ROLES    AGE     VERSION                              
app-pool-849ri       Ready    &lt;none&gt;   51s     v1.21.2                              
app-pool-849rv       Ready    &lt;none&gt;   33s     v1.21.2                              
default-pool-849j0   Ready    &lt;none&gt;   3m43s   v1.21.2                              
default-pool-849j1   Ready    &lt;none&gt;   4m41s   v1.21.2
</code></pre>
<!-- id: 5f0194057674c1687fd6b6f37d1b78f4 -->

<h3 id="private-registry-image-pulling"><a href="https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/">Private Registry</a> Image Pulling<a class="headerlink" href="#private-registry-image-pulling" title="Permanent link">¬§</a></h3>
<p>You want the container orchestrator (here Kubernetes) to pull from your private registry. The simplest way to do so
is:</p>
<ul>
<li>"Docker login" there</li>
<li>Tell K8s about it</li>
</ul>
<!-- id: a7e8e9072e53c5d92136435df12687fa -->

<div class="tabbed-set tabbed-alternate" data-tabs="7:2"><input checked="checked" id="__tabbed_7_1" name="__tabbed_7" type="radio" /><input id="__tabbed_7_2" name="__tabbed_7" type="radio" /><div class="tabbed-labels"><label for="__tabbed_7_1">Cmd</label><label for="__tabbed_7_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>podman login <span class="s2">&quot;</span><span class="k">$(</span>pass show reg/domain<span class="k">)</span><span class="s2">&quot;</span> -u <span class="k">$(</span>pass show reg/user<span class="k">)</span> -p <span class="s2">&quot;</span><span class="k">$(</span>pass show reg/passw<span class="k">)</span><span class="s2">&quot;</span>
<span class="gp">$ </span><span class="nv">fn</span><span class="o">=</span><span class="nv">$XDG_RUNTIME_DIR</span>/containers/auth.json <span class="c1"># podman&#39;s location. docker: elsewhere</span>
<span class="gp">$ </span>k create secret generic regcred --from-file<span class="o">=</span><span class="s2">&quot;.dockerconfigjson=</span><span class="nv">$fn</span><span class="s2">&quot;</span>  --type<span class="o">=</span>kubernetes.io/dockerconfigjson <span class="c1"># lp: asserts=regcred</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p><xterm /></p>
<pre><code>$ podman login "$(pass show reg/domain)" -u $(pass show reg/user) -p "$(pass show reg/passw)"       
Login Succeeded!
$ fn=$XDG_RUNTIME_DIR/containers/auth.json # podman's location. docker: elsewhere   
$ 
$ k create secret generic regcred --from-file=".dockerconfigjson=$fn"  --type=kubernetes.io/dockerconfigjson                                  
secret/regcred created
</code></pre>
</div>
</div>
</div>
<!-- id: a7e8e9072e53c5d92136435df12687fa -->

<p>Now at subsequent deploys you can specify sth like:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># (...)</span><span class="w"></span>
<span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;your image at private registry&gt;</span><span class="w"></span>
<span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">regcred</span><span class="w"></span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<ul>
<li>The value for <code>reg/domain</code> is like <code>your.private.registry.example.com</code></li>
<li>The value for <code>image</code> is like <code>your.private.registry.example.com/janedoe/jdoe-private:v1</code></li>
</ul>
</div>
<h2 id="discussion">Discussion<a class="headerlink" href="#discussion" title="Permanent link">¬§</a></h2>
<ul>
<li>
<p>"digitalocean_kubernetes_cluster" is from the Terraform Registry:
  <a href="https://registry.terraform.io/providers/digitalocean/digitalocean/latest/docs/resources/kubernetes_cluster">https://registry.terraform.io/providers/digitalocean/digitalocean/latest/docs/resources/kubernetes_cluster</a>. </p>
</li>
<li>
<p>Here you find many recipes ("modules") for systems deploys on K8s, not only for Dig.Ocean, e.g.
  <a href="https://registry.terraform.io/modules/rivernews/kubernetes-microservice/digitalocean/latest">https://registry.terraform.io/modules/rivernews/kubernetes-microservice/digitalocean/latest</a></p>
</li>
</ul>
<div class="admonition quote">
<p class="admonition-title">Not only for DO</p>
<p>This module currently assumes the use of Digitalocean Kubernetes Service. However, you may
easily change your favored kubernetes vendor by forking this repo and modify the content of
kubernetes-cluster.tf.</p>
<p>Repo is on Github: <a href="https://github.com/rivernews/terraform-digitalocean-kubernetes-microservice">https://github.com/rivernews/terraform-digitalocean-kubernetes-microservice</a></p>
</div>
<ul>
<li>
<p>Hitlist: <a href="https://registry.terraform.io/providers/digitalocean/digitalocean/latest">https://registry.terraform.io/providers/digitalocean/digitalocean/latest</a></p>
</li>
<li>
<p>Here more: <a href="https://registry.terraform.io/browse/providers">https://registry.terraform.io/browse/providers</a> </p>
</li>
</ul>
<h3 id="raw-kubernetes-is-hard">Raw Kubernetes is Hard<a class="headerlink" href="#raw-kubernetes-is-hard" title="Permanent link">¬§</a></h3>
<p>Have a look into <code>kubectl cluster-info dump</code>...</p>
<h3 id="config-security">Config / Security<a class="headerlink" href="#config-security" title="Permanent link">¬§</a></h3>
<p>On the web frontend of the cloud provider you can download a cluster config file, incl. a
<code>cluster_ca_certificate</code> value. That config, incl. the certificate is also found in the local <a href="https://www.terraform.io/docs/language/state/index.html"><code>./terraform.tfstate</code></a>, i.e. that file is sensitive. There are means to have that <a href="https://www.google.com/search?q=terraform+remote+state">stored remotely</a>.</p>
<h3 id="apply-errors-do-happen">Apply Errors Do Happen<a class="headerlink" href="#apply-errors-do-happen" title="Permanent link">¬§</a></h3>
<p>At apply I did get</p>
<div class="highlight"><pre><span></span><code>‚îÇ Error: Error creating Kubernetes cluster: Error trying to read cluster state: GET https://api.digitalocean.com/v2/kubernetes/clusters/587b36f7-1a1b-4b80-acd5-a933bac44125: 500 Server Error
‚îÇ
‚îÇ   with digitalocean_kubernetes_cluster.kubernetes_cluster,
‚îÇ   on do-kubernetes.tf line 1, in resource &quot;digitalocean_kubernetes_cluster&quot; &quot;kubernetes_cluster&quot;:
</code></pre></div>
<p>or </p>
<div class="highlight"><pre><span></span><code>‚îÇ Error: Error creating Kubernetes cluster: Error trying to read cluster state: Get &quot;https://api.digitalocean.com/v2/kubernetes/clusters/85ff2d69-a0c3-4b38-bb59-3f3dca1dc09c&quot;: read tcp 10.0.0.84:47880-&gt;104.16.182.15:443: read: connection reset by peer
‚îÇ
</code></pre></div>
<p>after 6 minutes of installation time... </p>
<p>This I consider sth not TF to blame for (rather DO), i.e. you have to take apply errors into account writing your
infrastructure provisioning machinery anyway.</p>
<p>But <strong>this</strong> I do consider a bug:</p>
<p>A subsequent run (after a <code>tf destroy</code>(!)) error-ed out with <code>‚îÇ Error: Error creating Kubernetes cluster: POST https://api.digitalocean.com/v2/kubernetes/clusters: 422 a cluster with this name already exists</code>.</p>
<p>Had to delete the k8s cluster manually on the DO UI -&gt; TF was clearly out of sync here.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>I consider this a bug of the digitalocean_kubernetes_cluster resource implementation, at the destroy
implementation.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Use deploy unique names</p>
<p>Especially with very complex resources like a k8s cluster it makes a lot of sense to not use the
same names for re-deploys after destroy. I did see people appending unixtimestamps to resource
names...</p>
<p>The infrastructure provider, while having acked the
destroy seems to still have some ongoing cleanup jobs (or maybe DNS timeouts?) going on.</p>
<p>At deploys with unique names I never got problems at apply - so far.</p>
</div>
<h2 id="further-readings">Further Readings<a class="headerlink" href="#further-readings" title="Permanent link">¬§</a></h2>
<ul>
<li>Tanzu with Terraform: <a href="https://williamlam.com/2020/11/using-terraform-to-deploy-a-tanzu-kubernetes-grid-tkg-cluster-in-vsphere-with-tanzu.html">https://williamlam.com/2020/11/using-terraform-to-deploy-a-tanzu-kubernetes-grid-tkg-cluster-in-vsphere-with-tanzu.html</a></li>
<li><a href="https://www.hashicorp.com/blog/deploy-any-resource-with-the-new-kubernetes-provider-for-hashicorp-terraform">https://www.hashicorp.com/blog/deploy-any-resource-with-the-new-kubernetes-provider-for-hashicorp-terraform</a></li>
</ul>
<h3 id="k8s-os">K8s -&gt; OS<a class="headerlink" href="#k8s-os" title="Permanent link">¬§</a></h3>
<ul>
<li><a href="https://techbloc.net/archives/3428">https://techbloc.net/archives/3428</a></li>
<li><a href="https://medium.com/@fabiojose/platform-as-code-with-openshift-terraform-1da6af7348ce">https://medium.com/@fabiojose/platform-as-code-with-openshift-terraform-1da6af7348ce</a></li>
<li><a href="https://github.com/cptmorgan-rh/install-oc-tools">https://github.com/cptmorgan-rh/install-oc-tools</a></li>
<li><a href="https://registry.terraform.io/providers/llomgui/openshift/latest/docs/guides/getting-started">https://registry.terraform.io/providers/llomgui/openshift/latest/docs/guides/getting-started</a></li>
<li><a href="http://www.matthiassommer.it/programming/deploying-grafana-openshift-terraform/">http://www.matthiassommer.it/programming/deploying-grafana-openshift-terraform/</a></li>
</ul>
<h3 id="svc-mesh">Svc Mesh<a class="headerlink" href="#svc-mesh" title="Permanent link">¬§</a></h3>
<ul>
<li><a href="https://platform9.com/blog/kubernetes-service-mesh-a-comparison-of-istio-linkerd-and-consul/">https://platform9.com/blog/kubernetes-service-mesh-a-comparison-of-istio-linkerd-and-consul/</a></li>
</ul>

<script>typeof start_lc === "undefined" ? 0 : start_lc() </script>


              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        
<style>
  .md-footer__link--next {
    width: 75%;
  }
  .overlay_block {
    position: relative;
    width: 100%;
  }
  .overlay_block .overlay_link {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    right: 0;
  }
  .overlay_block .overlay_inner {
    position: relative;
    pointer-events: none;
    z-index: 1;
  }
  .overlay_block .overlay_inner a {
    pointer-events: all;
  }
</style>

<footer class="md-footer">
  

    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../" class="md-footer__link md-footer__link--prev" aria-label="Previous: Kubernetes" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Kubernetes
            </div>
          </div>
        </a>



       
      <div class="md-footer__link md-footer__link--next">
        
        <div class="overlay_block">
          <a
            class="overlay_link"
            href="../k8s_provider/do_k8s/"
            rel="next"
          ></a>
          <div class="overlay_inner">
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Next
                </span>
                
                <a href="/blog/cloud/dnsmasq/">
                    
                  <small>üí≠ CLOUD</small> - 
                </a>
                
                <a href="/blog/cloud/terraform/">
                    
                  <small>Terraform</small> - 
                </a>
                
                <a href="/blog/cloud/terraform/k8s/k8s_provider/do_k8s/">
                     <span>Attaching Using Token Only</span> 
                </a>
                
              </div>
            </div>
          </div>
        </div>
        <div style="margin-left: -2rem" class="md-footer__button md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
        </div>
      </div>




      
    </nav>
  </div>
  




  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; Gunther Klessinger

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://github.com/axiros" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>

      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.instant", "navigation.top", "navigation.tabs", "navigation.sections", "navigation.expand"], "search": "../../../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.6e54b5cd.min.js"></script>
      
        <script src="../../../../lcd/lp/javascript/fa_all.js"></script>
      
        <script src="../../../../lcd/lp/javascript/xterm-addon-search.min.js"></script>
      
        <script src="../../../../lcd/lp/javascript/xterm.4.9.0.min.js"></script>
      
        <script src="../../../../lcd/lp/javascript/Rx.min.js"></script>
      
        <script src="../../../../lcd/lp/javascript/tablesort.min.js"></script>
      
        <script src="../../../../lcd/lp/javascript/lc.js"></script>
      
        <script src="../../../../lcd/lp/javascript/xterm-addon-fit.min.js"></script>
      
        <script src="../../../../lcd/lp/javascript/tables.js"></script>
      
    
  </body>
</html>